# 一：复制

- 主要命令是**SLAVEOF**命令，在从服务器上面使用 ***SLAVE  IP PORT***，则可以配置主从关系

- 旧版复制功能，分为同步（sync）和命令传播（command propagate）。

  同步操作为：（1）从服务器向主服务器发送SYNC命令，（2）主服务器收到SYNC执行BGSAVE命令，在后台生成RDB文件，并使用缓冲区记录现在执行的写命令，（3）主服务器BGSAVE执行完成之后，将RDB文件发送给从服务器，从服务器接收到之后，载入RDB文件，（4）主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器执行。

  命令传播为：主要还是主服务器发送命令至从服务器。

  缺陷：当从服务器断开之后，重新发送SYNC命令，主服务器生成RDB文件时，会将从服务器中已有的数据继续写进去，做法很低效。

- 新版复制功能，使用PSYNC命令代替SYNC命令执行复制时的同步操作。PSYNC分为完全重同步和部分重同步，完全重同步只发生在初次复制，部分重同步（偏移量，复制积压缓冲区，服务器运行ID）处理断线后复制。

  偏移量：部分重同步需要记录主从两台服务器上面的复制偏移量，偏移量以字节来记录。

  复制积压缓冲区：主服务器会将最近执行的命令记录在复制积压缓冲区，短暂的从服务器断开，可以直接将缓冲区数据同步过去，不用同步RDB文件。

  服务器运行ID：另外为了从服务器分辨是否为上一次同步的主服务器，在第一次同步时会生成40位ID同步给从服务器。

- 心跳检测，从服务器默认1次/s的频率向主服务器发送命令，可以实现检测主从网络连接，实现min-slaves选项，检测命令丢失。

  redis中有min-slaves-to-write和min-slaves-max-log两个选项，可以防止在服务器不安全的情况下执行写命令，例如前者为3，后者为10，那么在从服务器小于3个，或者延迟大于等于10秒，拒绝写命令。

# 二：sentinel

- 哨兵模式，主要是用于监控主从服务器之间，健康状态，当主服务器下线超过配置的时间之后，就是选举一个新的子节点作为新的主服务器，在此时sentinel还会继续监控下线的主服务器，当以前的主服务器重新上线之后，会作为新的主服务器的从服务器。启动命令为，redis-sentinel /path/\*/sentinel.conf或者redis-server /path/\*/sentinel.conf --sentinel。
- 



# 三：集群

